#!/usr/bin/env bash

root=$(git rev-parse --show-toplevel)
source $root/scripts/common.bash
files=$(git status --porcelain | grep -v -E "^\sD\s" | awk '{ $1=""; print}' | grep -E *.go$)
if [[ -z $files ]]; then
    exit 0
fi

_set_fmt_error_code() {
    if [[ -n $1 ]]; then
        echo -e "${yellow_bg}${black_txt}${bold}Format error:${reset} $1"
        return 1
    fi
}

_check_error_code() {
    if [[ $1 != 0 ]]; then
      error=1
      printf "\n"
    fi
}

error=0
files=$(sed 's#^\s#''#g' <<< $files)
while read file; do
    abs="$root/$file"
    golint --set_exit_status "$abs"
    _check_error_code $?

    go vet "$abs"
    _check_error_code $?

    unformattedFile=$(gofmt -l "$abs")
    _set_fmt_error_code $unformattedFile
    _check_error_code $?
done <<< $files

exit $error
